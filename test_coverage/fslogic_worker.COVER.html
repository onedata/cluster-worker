<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/piotrek/Dokumenty/OneData/merge_merge/op-worker/test_coverage/fslogic_worker.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/piotrek/Dokumenty/OneData/merge_merge/op-worker/ebin/../src/modules/fslogic/fslogic_worker.erl by COVER 2015-08-06 at 11:00:40

****************************************************************************

        |  %%%--------------------------------------------------------------------
        |  %%% @author Rafal Slota
        |  %%% @copyright (C) 2015 ACK CYFRONET AGH
        |  %%% This software is released under the MIT license
        |  %%% cited in 'LICENSE.txt'.
        |  %%% @end
        |  %%%--------------------------------------------------------------------
        |  %%% @doc This module implements worker_plugin_behaviour callbacks.
        |  %%%      Also it decides whether request has to be handled locally or rerouted
        |  %%%      to other priovider.
        |  %%% @end
        |  %%%--------------------------------------------------------------------
        |  -module(fslogic_worker).
        |  -behaviour(worker_plugin_behaviour).
        |  
        |  -include("errors.hrl").
        |  -include("global_definitions.hrl").
        |  -include("modules/fslogic/fslogic_common.hrl").
        |  -include("proto/oneclient/fuse_messages.hrl").
        |  -include("proto/oneclient/common_messages.hrl").
        |  -include_lib("ctool/include/logging.hrl").
        |  
        |  
        |  -export([init/1, handle/1, cleanup/0, handle_fuse_request/2]).
        |  
        |  %%%===================================================================
        |  %%% Types
        |  %%%===================================================================
        |  
        |  -type ctx() :: #fslogic_ctx{}.
        |  -type file() :: file_meta:entry(). %% Type alias for better code organization
        |  -type open_flags() :: read | write | rwrd.
        |  -type posix_permissions() :: file_meta:posix_permissions().
        |  
        |  -export_type([ctx/0, file/0, open_flags/0, posix_permissions/0]).
        |  
        |  %%%===================================================================
        |  %%% worker_plugin_behaviour callbacks
        |  %%%===================================================================
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link worker_plugin_behaviour} callback init/1.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec init(Args :: term()) -&gt; Result when
        |      Result :: {ok, State :: worker_host:plugin_state()} | {error, Reason :: term()}.
        |  init(_Args) -&gt;
    30..|      {ok, #{}}.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link worker_plugin_behaviour} callback handle/1.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec handle(Request) -&gt; Result when
        |      Request :: ping | healthcheck | {fuse_request, SessId :: session:id(),
        |          FuseRequest :: #fuse_request{}},
        |      Result :: nagios_handler:healthcheck_response() | ok | {ok, Response} |
        |      {error, Reason} | pong,
        |      Response :: term(),
        |      Reason :: term().
        |  handle(ping) -&gt;
<font color=red>     0..|      pong;</font>
        |  handle(healthcheck) -&gt;
    89..|      ok;
        |  handle({fuse_request, SessId, FuseRequest}) -&gt;
  1184..|      maybe_handle_fuse_request(SessId, FuseRequest);
        |  handle(_Request) -&gt;
<font color=red>     0..|      ?log_bad_request(_Request),</font>
<font color=red>     0..|      {error, wrong_request}.</font>
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link worker_plugin_behaviour} callback cleanup/0
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec cleanup() -&gt; Result when
        |      Result :: ok | {error, Error},
        |      Error :: timeout | term().
        |  cleanup() -&gt;
    30..|      ok.
        |  
        |  %%%===================================================================
        |  %%% Internal functions
        |  %%%===================================================================
        |  
        |  %%--------------------------------------------------------------------
        |  %% @private
        |  %% @doc
        |  %% Handles or forwards FUSE request. In case of error translates it using
        |  %% fslogic_errors:translate_error/1 function.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec maybe_handle_fuse_request(SessId :: session:id(), FuseRequest :: #fuse_request{}) -&gt;
        |      FuseResponse :: #fuse_response{}.
        |  maybe_handle_fuse_request(SessId, FuseRequest) -&gt;
  1184..|      try
  1184..|          ?debug("Processing request: ~p", [FuseRequest]),
  1184..|          {ok, #document{value = Session}} = session:get(SessId),
  1184..|          ?info("Fuse request ~p from user ~p", [FuseRequest, Session]),
  1184..|          Resp = handle_fuse_request(#fslogic_ctx{session = Session}, FuseRequest),
  1084..|          ?info("Fuse request ~p from user ~p: ~p", [FuseRequest, Session, Resp]),
  1084..|          Resp
        |      catch
        |          Reason -&gt;
        |              %% Manually thrown error, normal interrupt case.
    97..|              report_error(FuseRequest, Reason, debug);
        |          error:{badmatch, Reason} -&gt;
        |              %% Bad Match assertion - something went wrong, but it could be expected.
     3..|              report_error(FuseRequest, Reason, warning);
        |          error:{case_clause, Reason} -&gt;
        |              %% Case Clause assertion - something went seriously wrong and we should know about it.
<font color=red>     0..|              report_error(FuseRequest, Reason, error);</font>
        |          error:Reason -&gt;
        |              %% Something went horribly wrong. This should not happen.
<font color=red>     0..|              report_error(FuseRequest, Reason, error)</font>
        |      end.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @private
        |  %% @doc
        |  %% Returns a FUSE response with translated error description.
        |  %% Logs an error with given log level.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec report_error(FuseRequest :: #fuse_request{}, Error :: term(),
        |      LogLevel :: debug | warning | error) -&gt; FuseResponse :: #fuse_response{}.
        |  report_error(FuseRequest, Error, LogLevel) -&gt;
   100..|      Status = #status{code = Code, description = Description} =
        |          fslogic_errors:gen_status_message(Error),
   100..|      MsgFormat = "Cannot process request ~p due to unknown error: ~p (code: ~p)",
   100..|      case LogLevel of
    97..|          debug -&gt; ?debug_stacktrace(MsgFormat, [FuseRequest, Description, Code]);
     3..|          warning -&gt; ?warning_stacktrace(MsgFormat, [FuseRequest, Description, Code]);
<font color=red>     0..|          error -&gt; ?error_stacktrace(MsgFormat, [FuseRequest, Description, Code])</font>
        |      end,
   100..|      #fuse_response{status = Status}.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @private
        |  %% @doc
        |  %% Processes a FUSE request and returns a response.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec handle_fuse_request(Ctx :: fslogic_worker:ctx(), FuseRequest :: fuse_request()) -&gt;
        |      FuseResponse :: #fuse_response{}.
        |  handle_fuse_request(Ctx, #get_file_attr{entry = {path, Path}}) -&gt;
   181..|      {ok, Tokens} = fslogic_path:verify_file_path(Path),
   181..|      CanonicalFileEntry = fslogic_path:get_canonical_file_entry(Ctx, Tokens),
   181..|      fslogic_req_generic:get_file_attr(Ctx, CanonicalFileEntry);
        |  handle_fuse_request(Ctx, #get_file_attr{entry = Entry}) -&gt;
    12..|      fslogic_req_generic:get_file_attr(Ctx, Entry);
        |  handle_fuse_request(Ctx, #delete_file{uuid = UUID}) -&gt;
    52..|      fslogic_req_generic:delete_file(Ctx, {uuid, UUID});
        |  handle_fuse_request(Ctx, #create_dir{parent_uuid = ParentUUID, name = Name, mode = Mode}) -&gt;
    46..|      fslogic_req_special:mkdir(Ctx, ParentUUID, Name, Mode);
        |  handle_fuse_request(Ctx, #get_file_children{uuid = UUID, offset = Offset, size = Size}) -&gt;
   852..|      fslogic_req_special:read_dir(Ctx, {uuid, UUID}, Offset, Size);
        |  handle_fuse_request(Ctx, #change_mode{uuid = UUID, mode = Mode}) -&gt;
    32..|      fslogic_req_generic:chmod(Ctx, {uuid, UUID}, Mode);
        |  handle_fuse_request(Ctx, #rename{uuid = UUID, target_path = TargetPath}) -&gt;
     1..|      fslogic_req_generic:rename_file(Ctx, {uuid, UUID}, TargetPath);
        |  handle_fuse_request(Ctx, #update_times{uuid = UUID, atime = ATime, mtime = MTime, ctime = CTime}) -&gt;
     8..|      fslogic_req_generic:update_times(Ctx, {uuid, UUID}, ATime, MTime, CTime);
        |  handle_fuse_request(_Ctx, Req) -&gt;
<font color=red>     0..|      ?log_bad_request(Req),</font>
<font color=red>     0..|      erlang:error({invalid_request, Req}).</font>
</pre>
</body>
</html>
