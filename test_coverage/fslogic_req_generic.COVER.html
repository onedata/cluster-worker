<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/piotrek/Dokumenty/OneData/merge_merge/op-worker/test_coverage/fslogic_req_generic.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/piotrek/Dokumenty/OneData/merge_merge/op-worker/ebin/../src/modules/fslogic/fslogic_requests/fslogic_req_generic.erl by COVER 2015-08-06 at 11:00:42

****************************************************************************

        |  %%%-------------------------------------------------------------------
        |  %%% @author Rafal Slota
        |  %%% @copyright (C) 2015 ACK CYFRONET AGH
        |  %%% This software is released under the MIT license
        |  %%% cited in 'LICENSE.txt'.
        |  %%% @end
        |  %%%-------------------------------------------------------------------
        |  %%% @doc FSLogic generic (both for regular and special files) request handlers.
        |  %%% @end
        |  %%%-------------------------------------------------------------------
        |  -module(fslogic_req_generic).
        |  -author("Rafal Slota").
        |  
        |  -include("proto/oneclient/fuse_messages.hrl").
        |  -include("modules/fslogic/fslogic_common.hrl").
        |  -include_lib("ctool/include/logging.hrl").
        |  
        |  %% API
        |  -export([chmod/3, get_file_attr/2, delete_file/2, rename_file/3, update_times/5]).
        |  
        |  %%--------------------------------------------------------------------
        |  %% API functions
        |  %%--------------------------------------------------------------------
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Changes file's access times.
        |  %% For best performance use following arg types: document -&gt; uuid -&gt; path
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec update_times(fslogic_worker:ctx(), File :: fslogic_worker:file(),
        |      ATime :: file_meta:time(), MTime :: file_meta:time(), CTime :: file_meta:time()) -&gt; #fuse_response{} | no_return().
        |  -check_permissions({none, 2}).
        |  update_times(_CTX, File, ATime, MTime, CTime) -&gt;
     8..|      UpdateMap = #{atime =&gt; ATime, mtime =&gt; MTime, ctime =&gt; CTime},
     8..|      UpdateMap1 = maps:from_list([{Key, Value} || {Key, Value} &lt;- maps:to_list(UpdateMap), is_integer(Value)]),
     8..|      {ok, _} = file_meta:update(File, UpdateMap1),
     8..|      #fuse_response{status = #status{code = ?OK}}.
        |  
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Changes file permissions.
        |  %% For best performance use following arg types: document -&gt; uuid -&gt; path
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec chmod(fslogic_worker:ctx(), File :: fslogic_worker:file(), Perms :: fslogic_worker:posix_permissions()) -&gt;
        |      #fuse_response{} | no_return().
        |  -check_permissions({owner, 2}).
        |  chmod(_CTX, File, Mode) -&gt;
     5..|      {ok, _} = file_meta:update(File, #{mode =&gt; Mode}),
     5..|      #fuse_response{status = #status{code = ?OK}}.
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Changes file owner.
        |  %% For best performance use following arg types: document -&gt; uuid -&gt; path
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec chown(fslogic_worker:ctx(), File :: fslogic_worker:file(), UserId :: onedata_user:id()) -&gt;
        |      #fuse_response{} | no_return().
        |  -check_permissions(root).
        |  chown(_, _File, _UserId) -&gt;
<font color=red>     0..|      #fuse_response{status = #status{code = ?ENOTSUP}}.</font>
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Gets file's attributes.
        |  %% For best performance use following arg types: document -&gt; uuid -&gt; path
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get_file_attr(Ctx :: fslogic_worker:ctx(), File :: fslogic_worker:file()) -&gt;
        |      FuseResponse :: #fuse_response{} | no_return().
        |  -check_permissions({none, 2}).
        |  get_file_attr(_CTX, File) -&gt;
   178..|      ?debug("Get attr for file entry: ~p", [File]),
   178..|      case file_meta:get(File) of
        |          {ok, #document{key = UUID, value = #file_meta{
        |              type = Type, mode = Mode, atime = ATime, mtime = MTime,
        |              ctime = CTime, uid = UID, size = Size, name = Name}}} -&gt;
   178..|              #fuse_response{status = #status{code = ?OK}, fuse_response =
        |                              #file_attr{
        |                                  uuid = UUID, type = Type, mode = Mode, atime = ATime, mtime = MTime,
        |                                  ctime = CTime, uid = fslogic_utils:gen_storage_uid(UID), size = Size, name = Name
        |                              }};
        |          {error, {not_found, _}} -&gt;
<font color=red>     0..|              #fuse_response{status = #status{code = ?ENOENT}}</font>
        |      end.
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Deletes file.
        |  %% For best performance use following arg types: document -&gt; uuid -&gt; path
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec delete_file(fslogic_worker:ctx(), File :: fslogic_worker:file()) -&gt;
        |      FuseResponse :: #fuse_response{} | no_return().
        |  -check_permissions([{write, {parent, 2}}, {owner_if_parent_sticky, 2}]).
        |  delete_file(_, File) -&gt;
     7..|      {ok, #document{value = #file_meta{type = Type}} = FileDoc} = file_meta:get(File),
     7..|      {ok, FileChildren} = case Type of
        |                               ?DIRECTORY_TYPE -&gt;
     7..|                                   file_meta:list_children(FileDoc, 0, 1);
        |                               _ -&gt;
<font color=red>     0..|                                   {ok, []}</font>
        |                           end,
     7..|      case length(FileChildren) of
        |          0 -&gt;
     3..|              ok = file_meta:delete(FileDoc),
     3..|              {ok, ParentDoc} = file_meta:get_parent(FileDoc),
     3..|              {ok, _} = file_meta:update(ParentDoc, #{mtime =&gt; utils:time()}),
     3..|              #fuse_response{status = #status{code = ?OK}};
        |          _ -&gt;
     4..|              #fuse_response{status = #status{code = ?ENOTEMPTY}}
        |      end.
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Renames file.
        |  %% For best performance use following arg types: path -&gt; uuid -&gt; document
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec rename_file(fslogic_worker:ctx(), SourceEntry :: fslogic_worker:file(), TargetPath :: file_meta:path()) -&gt;
        |      #fuse_response{} | no_return().
        |  -check_permissions([{write, {parent, 2}}, {write, 2}, {write, {parent, {path, 3}}}]).
        |  rename_file(_CTX, SourceEntry, TargetPath) -&gt;
     1..|      ?debug("Renaming file ~p to ~p...", [SourceEntry, TargetPath]),
     1..|      case file_meta:exists({path, TargetPath}) of
        |          true -&gt;
<font color=red>     0..|              #fuse_response{status = #status{code = ?EEXIST}};</font>
        |          false -&gt;
     1..|              ok = file_meta:rename(SourceEntry, {path, TargetPath}),
     1..|              #fuse_response{status = #status{code = ?OK}}
        |      end.
        |  
        |  %%--------------------------------------------------------------------
        |  %% Internal functions
        |  %%--------------------------------------------------------------------</pre>
</body>
</html>
