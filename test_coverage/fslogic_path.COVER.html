<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/piotrek/Dokumenty/OneData/merge_merge/op-worker/test_coverage/fslogic_path.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/piotrek/Dokumenty/OneData/merge_merge/op-worker/ebin/../src/modules/fslogic/fslogic_path.erl by COVER 2015-08-06 at 11:00:42

****************************************************************************

        |  %% ===================================================================
        |  %% @author Rafal Slota
        |  %% @copyright (C): 2013 ACK CYFRONET AGH
        |  %% This software is released under the MIT license
        |  %% cited in 'LICENSE.txt'.
        |  %% @end
        |  %% ===================================================================
        |  %% @doc: This module provides set of path processing methods.
        |  %% @end
        |  %% ===================================================================
        |  -module(fslogic_path).
        |  -author("Rafal Slota").
        |  
        |  -include("modules/fslogic/fslogic_common.hrl").
        |  -include_lib("ctool/include/logging.hrl").
        |  -include_lib("ctool/include/global_registry/gr_spaces.hrl").
        |  
        |  %% API
        |  -export([verify_file_path/1, get_canonical_file_entry/2]).
        |  -export([basename/1, split/1, join/1, is_space_dir/1]).
        |  -export([ensure_path_begins_with_slash/1]).
        |  -export([spaces_uuid/1]).
        |  
        |  %%%===================================================================
        |  %%% API functions
        |  %%%===================================================================
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Returns UUID of user's main 'spaces' directory.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec spaces_uuid(UserId :: onedata_user:id()) -&gt; file_meta:uuid().
        |  spaces_uuid(UserId) -&gt;
   905..|      base64:encode(term_to_binary({UserId, ?SPACES_BASE_DIR_NAME})).
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Same as {@link filename:split/1} but platform independent.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec split(Path :: file_meta:path()) -&gt; [binary()].
        |  split(Path) -&gt;
  1014..|      Bins = binary:split(Path, &lt;&lt;?DIRECTORY_SEPARATOR&gt;&gt;, [global]),
  1014..|      Bins1 = [Bin || Bin &lt;- Bins, Bin =/= &lt;&lt;""&gt;&gt;],
  1014..|      case Path of
        |          &lt;&lt;?DIRECTORY_SEPARATOR, _/binary&gt;&gt; -&gt;
   186..|              [&lt;&lt;?DIRECTORY_SEPARATOR&gt;&gt; | Bins1];
   828..|          _ -&gt; Bins1
        |      end.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Joins binary tokens into a binary path.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec join(list(binary())) -&gt; binary().
        |  join([]) -&gt;
<font color=red>     0..|      &lt;&lt;&gt;&gt;;</font>
        |  join([&lt;&lt;?DIRECTORY_SEPARATOR&gt;&gt; = Sep, &lt;&lt;?DIRECTORY_SEPARATOR&gt;&gt; | Tokens]) -&gt;
<font color=red>     0..|      join([Sep | Tokens]);</font>
        |  join([&lt;&lt;?DIRECTORY_SEPARATOR&gt;&gt; = Sep | Tokens]) -&gt;
   449..|      &lt;&lt;Sep/binary, (join(Tokens))/binary&gt;&gt;;
        |  join(Tokens) -&gt;
   449..|      Tokens1 = lists:map(fun
        |          StripFun(Token) -&gt;
   824..|              Size1 = byte_size(Token) - 1,
   824..|              Size2 = byte_size(Token) - 2,
   824..|              case Token of
        |                  &lt;&lt;?DIRECTORY_SEPARATOR, Tok:(Size2)/binary, ?DIRECTORY_SEPARATOR&gt;&gt; -&gt;
<font color=red>     0..|                      StripFun(Tok);</font>
        |                  &lt;&lt;?DIRECTORY_SEPARATOR, Tok/binary&gt;&gt; -&gt;
    21..|                      StripFun(Tok);
        |                  &lt;&lt;Tok:Size1/binary, ?DIRECTORY_SEPARATOR&gt;&gt; -&gt;
<font color=red>     0..|                      StripFun(Tok);</font>
        |                  Tok -&gt;
   803..|                      Tok
        |              end
        |      end, Tokens),
   449..|      Tokens2 = [Bin || Bin &lt;- Tokens1, Bin =/= &lt;&lt;""&gt;&gt;],
   449..|      binary_join(Tokens2, &lt;&lt;?DIRECTORY_SEPARATOR&gt;&gt;).
        |  
        |  
        |  -spec binary_join([binary()], binary()) -&gt; binary().
        |  binary_join([], _Sep) -&gt;
<font color=red>     0..|      &lt;&lt;&gt;&gt;;</font>
        |  binary_join([Part], _Sep) -&gt;
   288..|      Part;
        |  binary_join(List, Sep) -&gt;
   161..|      lists:foldr(fun(A, B) -&gt;
   494..|          if
   333..|              bit_size(B) &gt; 0 -&gt; &lt;&lt;A/binary, Sep/binary, B/binary&gt;&gt;;
   161..|              true -&gt; A
        |          end
        |      end, &lt;&lt;&gt;&gt;, List).
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Gets file's full name (user's root is added to name, but only when
        |  %% asking about non-group dir).
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get_canonical_file_entry(Ctx :: fslogic_worker:ctx(), Tokens :: [file_meta:path()]) -&gt;
        |      FileEntry :: file_meta:entry().
        |  get_canonical_file_entry(Ctx, [&lt;&lt;?DIRECTORY_SEPARATOR&gt;&gt;]) -&gt;
    30..|      UserId = fslogic_context:get_user_id(Ctx),
    30..|      {uuid, UserId};
        |  get_canonical_file_entry(Ctx, [&lt;&lt;?DIRECTORY_SEPARATOR&gt;&gt;, ?SPACES_BASE_DIR_NAME]) -&gt;
    18..|      UserId = fslogic_context:get_user_id(Ctx),
    18..|      Path = fslogic_path:join([&lt;&lt;?DIRECTORY_SEPARATOR&gt;&gt;, UserId, ?SPACES_BASE_DIR_NAME]),
    18..|      {path, Path};
        |  get_canonical_file_entry(Ctx, [&lt;&lt;?DIRECTORY_SEPARATOR&gt;&gt;, ?SPACES_BASE_DIR_NAME | Tokens]) -&gt;
   112..|      Path = fslogic_path:join([&lt;&lt;?DIRECTORY_SEPARATOR&gt;&gt;, ?SPACES_BASE_DIR_NAME | Tokens]),
   112..|      {path, Path};
        |  get_canonical_file_entry(Ctx, Tokens) -&gt;
    21..|      UserId = fslogic_context:get_user_id(Ctx),
    21..|      {ok, #document{value = #onedata_user{space_ids = [DefaultSpaceId | _]}}} =
        |          onedata_user:get(UserId),
    21..|      {ok, #document{value = #file_meta{name = DefaultSpaceName}}} = file_meta:get(DefaultSpaceId),
    21..|      Path = fslogic_path:join([&lt;&lt;?DIRECTORY_SEPARATOR&gt;&gt;, ?SPACES_BASE_DIR_NAME,
        |          DefaultSpaceName | Tokens]),
    21..|      {path, Path}.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Strips '.' from path. Also if '..' path element if present, path is considered invalid.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec verify_file_path(FileName :: file_meta:path()) -&gt; Result when
        |      Result :: {ok, Tokens :: [binary()]} | {error, wrong_filename}.
        |  verify_file_path(FileName) -&gt;
   181..|      Tokens = lists:filter(fun(X) -&gt; X =/= &lt;&lt;"."&gt;&gt; end, split(FileName)),
   181..|      case lists:any(fun(X) -&gt; X =:= &lt;&lt;".."&gt;&gt; end, Tokens) of
<font color=red>     0..|          true -&gt; {error, wrong_filename};</font>
   181..|          _ -&gt; {ok, Tokens}
        |      end.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Gives file basename from given path
        |  -spec basename(Path :: file_meta:path()) -&gt; file_meta:path().
        |  %% ==================================================================
        |  basename(Path) -&gt;
<font color=red>     0..|      case lists:reverse(split(Path)) of</font>
<font color=red>     0..|          [Leaf | _] -&gt; Leaf;</font>
<font color=red>     0..|          _ -&gt; [&lt;&lt;?DIRECTORY_SEPARATOR&gt;&gt;]</font>
        |      end.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Returns true when Path points to space directory (or space root directory)
        |  %%--------------------------------------------------------------------
        |  -spec is_space_dir(Path :: file_meta:path()) -&gt; boolean().
        |  is_space_dir(Path) -&gt;
<font color=red>     0..|      case split(Path) of</font>
<font color=red>     0..|          [] -&gt; true;</font>
<font color=red>     0..|          [?SPACES_BASE_DIR_NAME] -&gt; true;</font>
<font color=red>     0..|          [?SPACES_BASE_DIR_NAME, _SpaceName] -&gt; true;</font>
<font color=red>     0..|          _ -&gt; false</font>
        |      end.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Ensures that path begins with "/"
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec ensure_path_begins_with_slash(Path :: file_meta:path()) -&gt; file_meta:path().
        |  ensure_path_begins_with_slash(&lt;&lt;?DIRECTORY_SEPARATOR, _R/binary&gt;&gt; = Path) -&gt;
     1..|      Path;
<font color=red>     0..|  ensure_path_begins_with_slash(Path) -&gt; &lt;&lt;?DIRECTORY_SEPARATOR, Path/binary&gt;&gt;.</font>
</pre>
</body>
</html>
