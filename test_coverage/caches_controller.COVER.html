<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/piotrek/Dokumenty/OneData/merge_merge/op-worker/test_coverage/caches_controller.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/piotrek/Dokumenty/OneData/merge_merge/op-worker/ebin/../src/modules/datastore/caches_controller.erl by COVER 2015-08-06 at 11:00:40

****************************************************************************

        |  %%%-------------------------------------------------------------------
        |  %%% @author Michal Wrzeszcz
        |  %%% @copyright (C) 2015 ACK CYFRONET AGH
        |  %%% This software is released under the MIT license
        |  %%% cited in 'LICENSE.txt'.
        |  %%% @end
        |  %%%-------------------------------------------------------------------
        |  %%% @doc
        |  %%% This module provides functions used by node manager to coordinate
        |  %%% clearing of not used values cached in memory.
        |  %%% @end
        |  %%%-------------------------------------------------------------------
        |  -module(caches_controller).
        |  -author("Michal Wrzeszcz").
        |  
        |  -include("global_definitions.hrl").
        |  -include("modules/datastore/datastore.hrl").
        |  -include_lib("ctool/include/logging.hrl").
        |  
        |  %% API
        |  -export([clear_local_cache/1, clear_global_cache/1, clear_local_cache/2, clear_global_cache/2]).
        |  -export([clear_cache/2, clear_cache/3, should_clear_cache/1, get_hooks_config/1]).
        |  -export([delete_old_keys/2, get_cache_uuid/2, decode_uuid/1]).
        |  
        |  %%%===================================================================
        |  %%% API
        |  %%%===================================================================
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Checks if memory should be cleared.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec should_clear_cache(MemUsage :: number()) -&gt; boolean().
        |  should_clear_cache(MemUsage) -&gt;
     1..|    {ok, TargetMemUse} = application:get_env(?APP_NAME, mem_to_clear_cache),
     1..|    MemUsage &gt;= TargetMemUse.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Clears local cache.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec clear_local_cache(Aggressive :: boolean()) -&gt; ok | mem_usage_too_high | cannot_check_mem_usage.
        |  clear_local_cache(Aggressive) -&gt;
<font color=red>     0..|    clear_cache(Aggressive, locally_cached).</font>
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Clears local cache.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec clear_local_cache(MemUsage :: number(), Aggressive :: boolean()) -&gt;
        |    ok | mem_usage_too_high | cannot_check_mem_usage.
        |  clear_local_cache(MemUsage, Aggressive) -&gt;
     2..|    clear_cache(MemUsage, Aggressive, locally_cached).
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Clears global cache.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec clear_global_cache(Aggressive :: boolean()) -&gt; ok | mem_usage_too_high | cannot_check_mem_usage.
        |  clear_global_cache(Aggressive) -&gt;
<font color=red>     0..|    clear_cache(Aggressive, globally_cached).</font>
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Clears global cache.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec clear_global_cache(MemUsage :: number(), Aggressive :: boolean()) -&gt;
        |    ok | mem_usage_too_high | cannot_check_mem_usage.
        |  clear_global_cache(MemUsage, Aggressive) -&gt;
     2..|    clear_cache(MemUsage, Aggressive, globally_cached).
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Clears cache.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec clear_cache(Aggressive :: boolean(), StoreType :: globally_cached | locally_cached) -&gt;
        |    ok | mem_usage_too_high | cannot_check_mem_usage.
        |  clear_cache(Aggressive, StoreType) -&gt;
<font color=red>     0..|    case monitoring:get_memory_stats() of</font>
        |      [{&lt;&lt;"mem"&gt;&gt;, MemUsage}] -&gt;
<font color=red>     0..|        clear_cache(MemUsage, Aggressive, StoreType);</font>
        |      _ -&gt;
<font color=red>     0..|        ?warning("Not able to check memory usage"),</font>
<font color=red>     0..|        cannot_check_mem_usage</font>
        |    end.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Clears cache.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec clear_cache(MemUsage :: number(), Aggressive :: boolean(), StoreType :: globally_cached | locally_cached) -&gt;
        |    ok | mem_usage_too_high | cannot_check_mem_usage.
        |  clear_cache(MemUsage, true, StoreType) -&gt;
     3..|    {ok, TargetMemUse} = application:get_env(?APP_NAME, mem_to_clear_cache),
     3..|    clear_cache(MemUsage, TargetMemUse, StoreType, [timer:minutes(10), 0]);
        |  
        |  clear_cache(MemUsage, _, StoreType) -&gt;
     4..|    {ok, TargetMemUse} = application:get_env(?APP_NAME, mem_to_clear_cache),
     4..|    clear_cache(MemUsage, TargetMemUse, StoreType, [timer:hours(7*24), timer:hours(24), timer:hours(1)]).
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Clears cache.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec clear_cache(MemUsage :: number(), TargetMemUse :: number(),
        |      StoreType :: globally_cached | locally_cached, TimeWindows :: list()) -&gt;
        |    ok | mem_usage_too_high | cannot_check_mem_usage.
        |  clear_cache(MemUsage, TargetMemUse, _StoreType, _TimeWindows) when MemUsage &lt; TargetMemUse -&gt;
     3..|    ok;
        |  
        |  clear_cache(_MemUsage, _TargetMemUse, _StoreType, []) -&gt;
     4..|    mem_usage_too_high;
        |  
        |  clear_cache(_MemUsage, TargetMemUse, StoreType, [TimeWindow | Windows]) -&gt;
    15..|    caches_controller:delete_old_keys(StoreType, TimeWindow),
    15..|    timer:sleep(1000), % time for system for mem info update
    15..|    case monitoring:get_memory_stats() of
        |      [{&lt;&lt;"mem"&gt;&gt;, NewMemUsage}] -&gt;
    15..|        clear_cache(NewMemUsage, TargetMemUse, StoreType, Windows);
        |      _ -&gt;
<font color=red>     0..|        ?warning("Not able to check memory usage"),</font>
<font color=red>     0..|        cannot_check_mem_usage</font>
        |    end.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Provides hooks configuration on the basis of models list.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get_hooks_config(Models :: list()) -&gt; list().
        |  get_hooks_config(Models) -&gt;
 45526..|    Methods = [save, get, exists, delete, update, create],
 45526..|    lists:foldl(fun(Model, Ans) -&gt;
 90852..|      ModelConfig = lists:map(fun(Method) -&gt;
545112..|        {Model, Method}
        |      end, Methods),
 90852..|      ModelConfig ++ Ans
        |    end, [], Models).
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Generates uuid on the basis of key and model name.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get_cache_uuid(Key :: datastore:key(), ModelName :: model_behaviour:model_type()) -&gt; binary().
        |  get_cache_uuid(Key, ModelName) -&gt;
 21760..|    base64:encode(term_to_binary({ModelName, Key})).
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Decodes uuid to key and model name.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec decode_uuid(binary()) -&gt; {Key :: datastore:key(), ModelName :: model_behaviour:model_type()}.
        |  decode_uuid(Uuid) -&gt;
   312..|    binary_to_term(base64:decode(Uuid)).
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Clears old documents from memory.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec delete_old_keys(StoreType :: globally_cached | locally_cached, TimeWindow :: integer()) -&gt; ok.
        |  delete_old_keys(globally_cached, TimeWindow) -&gt;
    49..|    delete_old_keys(global_cache_controller, global_only, ?GLOBAL_CACHES, TimeWindow);
        |  
        |  delete_old_keys(locally_cached, TimeWindow) -&gt;
    40..|    delete_old_keys(local_cache_controller, local_only, ?LOCAL_CACHES, TimeWindow).
        |  
        |  %%%===================================================================
        |  %%% Internal functions
        |  %%%===================================================================
        |  
        |  %%--------------------------------------------------------------------
        |  %% @private
        |  %% @doc
        |  %% Clears old documents from memory.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec delete_old_keys(Model :: global_cache_controller | local_cache_controller,
        |      Level :: global_only | local_only, Caches :: list(), TimeWindow :: integer()) -&gt; ok.
        |  delete_old_keys(Model, Level, Caches, TimeWindow) -&gt;
    89..|    {ok, Uuids} = apply(Model, list, [TimeWindow]),
    89..|    lists:foreach(fun(Uuid) -&gt;
   312..|      {ModelName, Key} = decode_uuid(Uuid),
   312..|      datastore:delete(Level, ModelName, Key)
        |    end, Uuids),
    89..|    case TimeWindow of
        |      0 -&gt;
    77..|        lists:foreach(fun(Cache) -&gt;
    80..|          {ok, Docs} = datastore:list(Level, Cache, ?GET_ALL, []),
    80..|          lists:foreach(fun(Doc) -&gt;
  3424..|            datastore:delete(Level, Cache, Doc#document.key)
        |          end, Docs)
        |        end, Caches);
        |      _ -&gt;
    12..|        ok
        |    end,
    89..|    ok.</pre>
</body>
</html>
