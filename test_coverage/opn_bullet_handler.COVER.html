<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/piotrek/Dokumenty/OneData/merge_merge/op-worker/test_coverage/opn_bullet_handler.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/piotrek/Dokumenty/OneData/merge_merge/op-worker/ebin/../src/modules/http_worker/gui/opn_bullet_handler.erl by COVER 2015-08-06 at 11:00:43

****************************************************************************

        |  %% Copyright (c) 2011-2012, Lo√Øc Hoguin &lt;essen@ninenines.eu&gt;
        |  %%
        |  %% Permission to use, copy, modify, and/or distribute this software for any
        |  %% purpose with or without fee is hereby granted, provided that the above
        |  %% copyright notice and this permission notice appear in all copies.
        |  %%
        |  %% THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
        |  %% WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
        |  %% MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
        |  %% ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
        |  %% WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
        |  %% ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
        |  %% OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
        |  
        |  %%%--------------------------------------------------------------------
        |  %%% @author Lukasz Opiola
        |  %%% @copyright (C) 2014 ACK CYFRONET AGH
        |  %%% This software is released under the MIT license
        |  %%% cited in 'LICENSE.txt'.
        |  %%% @end
        |  %%%--------------------------------------------------------------------
        |  %%% @doc Copy of n2o_bullet.erl from n2o.
        |  %%% This is a cowboy handler module for handling websocket connections for n2o.
        |  %%% Compared to original, this module has slight changes in the following functions:
        |  %%% - init/3
        |  %%% - handle/2
        |  %%% - info/3
        |  %%% @end
        |  %%% @todo function headers
        |  %%%--------------------------------------------------------------------
        |  -module(opn_bullet_handler).
        |  -author("Lukasz Opiola").
        |  
        |  -behaviour(cowboy_http_handler).
        |  -behaviour(cowboy_websocket_handler).
        |  
        |  -export([init/3]).
        |  -export([handle/2]).
        |  -export([info/3]).
        |  -export([terminate/3]).
        |  -export([websocket_init/3]).
        |  -export([websocket_handle/3]).
        |  -export([websocket_info/3]).
        |  -export([websocket_terminate/3]).
        |  
        |  -record(state, {
        |      handler :: module(),
        |      handler_state :: term()
        |  }).
        |  
        |  -define(TIMEOUT, 60000). %% @todo Configurable.
        |  
        |  %% HTTP.
        |  
        |  init(Transport, Req, Opts) -&gt;
<font color=red>     0..|      case cowboy_req:header(&lt;&lt;"upgrade"&gt;&gt;, Req) of</font>
        |          {undefined, Req2} -&gt;
<font color=red>     0..|              {Method, Req3} = cowboy_req:method(Req2),</font>
<font color=red>     0..|              init(Transport, Req3, Opts, Method);</font>
        |          {Bin, Req2} when is_binary(Bin) -&gt;
<font color=red>     0..|              case cowboy_bstr:to_lower(Bin) of</font>
        |                  &lt;&lt;"websocket"&gt;&gt; -&gt;
<font color=red>     0..|                      {upgrade, protocol, cowboy_websocket};</font>
        |                  _Any -&gt;
<font color=red>     0..|                      {ok, Req3} = opn_cowboy_bridge:apply(cowboy_req, reply, [501, [], [], Req2]),</font>
<font color=red>     0..|                      {shutdown, Req3, undefined}</font>
        |              end
        |      end.
        |  
        |  init(Transport, Req, Opts, &lt;&lt;"GET"&gt;&gt;) -&gt;
<font color=red>     0..|      {handler, Handler} = lists:keyfind(handler, 1, Opts),</font>
<font color=red>     0..|      State = #state{handler = Handler},</font>
<font color=red>     0..|      case Handler:init(Transport, Req, Opts, once) of</font>
        |          {ok, Req2, HandlerState} -&gt;
<font color=red>     0..|              Req3 = cowboy_req:compact(Req2),</font>
<font color=red>     0..|              {loop, Req3, State#state{handler_state = HandlerState},</font>
        |                  ?TIMEOUT, hibernate};
        |          {shutdown, Req2, HandlerState} -&gt;
<font color=red>     0..|              {shutdown, Req2, State#state{handler_state = HandlerState}}</font>
        |      end;
        |  init(Transport, Req, Opts, &lt;&lt;"POST"&gt;&gt;) -&gt;
<font color=red>     0..|      {handler, Handler} = lists:keyfind(handler, 1, Opts),</font>
<font color=red>     0..|      State = #state{handler = Handler},</font>
<font color=red>     0..|      case Handler:init(Transport, Req, Opts, false) of</font>
        |          {ok, Req2, HandlerState} -&gt;
<font color=red>     0..|              {ok, Req2, State#state{handler_state = HandlerState}};</font>
        |          {shutdown, Req2, HandlerState} -&gt;
<font color=red>     0..|              {shutdown, Req2, State#state{handler_state = HandlerState}}</font>
        |      end;
        |  init(Transport, Req, Opts, &lt;&lt;"OPTIONS"&gt;&gt;) -&gt;
<font color=red>     0..|      {handler, Handler} = lists:keyfind(handler, 1, Opts),</font>
<font color=red>     0..|      State = #state{handler = Handler},</font>
<font color=red>     0..|      case Handler:init(Transport, Req, Opts, once) of</font>
        |          {ok, Req2, HandlerState} -&gt;
<font color=red>     0..|              {ok, cowboy_req:compact(Req2), State#state{handler_state = HandlerState}};</font>
        |          {shutdown, Req2, HandlerState} -&gt;
<font color=red>     0..|              {shutdown, Req2, State#state{handler_state = HandlerState}}</font>
        |      end;
        |  
        |  init(_Transport, Req, _Opts, _Method) -&gt;
<font color=red>     0..|      {ok, Req2} = opn_cowboy_bridge:apply(cowboy_req, reply, [405, [], [], Req]),</font>
<font color=red>     0..|      {shutdown, Req2, undefined}.</font>
        |  
        |  handle(Req, State) -&gt;
<font color=red>     0..|      {Method, Req2} = cowboy_req:method(Req),</font>
<font color=red>     0..|      handle(Req2, State, Method).</font>
        |  handle(Req, State, &lt;&lt;"OPTIONS"&gt;&gt;) -&gt;
<font color=red>     0..|      Headers = [</font>
        |          {&lt;&lt;"Content-Type"&gt;&gt;, &lt;&lt;"text/html; charset=utf-8"&gt;&gt;},
        |          {&lt;&lt;"Access-Control-Allow-Origin"&gt;&gt;, &lt;&lt;"*"&gt;&gt;},
        |          {&lt;&lt;"Access-Control-Allow-Headers"&gt;&gt;, &lt;&lt;"X-Socket-Transport, Content-Type, x-requested-with, Accept"&gt;&gt;},
        |          {&lt;&lt;"Access-Control-Allow-Methods"&gt;&gt;, &lt;&lt;"GET, POST, PUT, DELETE, OPTIONS"&gt;&gt;}
        |      ],
<font color=red>     0..|      {ok, Req1} = opn_cowboy_bridge:apply(cowboy_req, reply, [200, Headers, [], cowboy_req:compact(Req)]),</font>
<font color=red>     0..|      {ok, Req1, State};</font>
        |  handle(Req, State = #state{handler = Handler, handler_state = HandlerState},
        |      &lt;&lt;"POST"&gt;&gt;) -&gt;
<font color=red>     0..|      case opn_cowboy_bridge:apply(cowboy_req, body, [Req]) of</font>
        |          {ok, Data, Req2} -&gt;
<font color=red>     0..|              case Handler:stream(Data, Req2, HandlerState) of</font>
        |                  {ok, Req3, HandlerState2} -&gt;
<font color=red>     0..|                      {ok, Req3, State#state{handler_state = HandlerState2}};</font>
        |                  {reply, Reply, Req3, HandlerState2} -&gt;
<font color=red>     0..|                      {ok, Req4} = opn_cowboy_bridge:apply(cowboy_req, reply, [200, [], Reply, Req3]),</font>
<font color=red>     0..|                      {ok, Req4, State#state{handler_state = HandlerState2}}</font>
        |              end;
        |          {error, _} -&gt;
        |              %% An error occurred, stop there.
<font color=red>     0..|              {ok, Req, State}</font>
        |      end.
        |  
        |  info(Message, Req,
        |      State = #state{handler = Handler, handler_state = HandlerState}) -&gt;
<font color=red>     0..|      case Handler:info(Message, Req, HandlerState) of</font>
        |          {ok, Req2, HandlerState2} -&gt;
<font color=red>     0..|              {loop, Req2, State#state{handler_state = HandlerState2}, hibernate};</font>
        |          {reply, Data, Req2, HandlerState2} -&gt;
<font color=red>     0..|              {ok, Req3} = opn_cowboy_bridge:apply(cowboy_req, reply, [200, [], Data, Req2]),</font>
<font color=red>     0..|              {ok, Req3, State#state{handler_state = HandlerState2}}</font>
        |      end.
        |  
        |  terminate(_Reason, _Req, undefined) -&gt;
<font color=red>     0..|      wf:info(?MODULE, "bullet_handler terminate", []),</font>
<font color=red>     0..|      ok;</font>
        |  terminate(_Reason, Req, #state{handler = Handler, handler_state = HandlerState}) -&gt;
<font color=red>     0..|      wf:info(?MODULE, "bullet_handler state terminate", []),</font>
<font color=red>     0..|      Handler:terminate(Req, HandlerState).</font>
        |  
        |  %% Websocket.
        |  
        |  websocket_init(Transport, Req, Opts) -&gt;
<font color=red>     0..|      {handler, Handler} = lists:keyfind(handler, 1, Opts),</font>
<font color=red>     0..|      State = #state{handler = Handler},</font>
<font color=red>     0..|      case Handler:init(Transport, Req, Opts, true) of</font>
        |          {ok, Req2, HandlerState} -&gt;
<font color=red>     0..|              Req3 = cowboy_req:compact(Req2),</font>
<font color=red>     0..|              {ok, Req3, State#state{handler_state = HandlerState},</font>
        |                  ?TIMEOUT, hibernate};
        |          {shutdown, Req2, _HandlerState} -&gt;
<font color=red>     0..|              {shutdown, Req2}</font>
        |      end.
        |  
        |  websocket_handle(Data, Req,
        |      State = #state{handler = Handler, handler_state = HandlerState}) -&gt;
<font color=red>     0..|      case Handler:stream(Data, Req, HandlerState) of</font>
        |          {ok, Req2, HandlerState2} -&gt;
<font color=red>     0..|              {ok, Req2, State#state{handler_state = HandlerState2}, hibernate};</font>
        |          {reply, {binary, Reply}, Req2, HandlerState2} -&gt;
        |  %		        wf:info(?MODULE,"Bullet Handle Binary"),
<font color=red>     0..|              {reply, {binary, Reply}, Req2,</font>
        |                  State#state{handler_state = HandlerState2}, hibernate};
        |          {reply, Reply, Req2, HandlerState2} -&gt;
<font color=red>     0..|              {reply, {text, Reply}, Req2,</font>
        |                  State#state{handler_state = HandlerState2}, hibernate}
        |      end.
        |  %websocket_handle(_Frame, Req, State) -&gt;
        |  %	{ok, Req, State, hibernate}.
        |  
        |  websocket_info(Info, Req, State = #state{
        |      handler = Handler, handler_state = HandlerState}) -&gt;
<font color=red>     0..|      case Handler:info(Info, Req, HandlerState) of</font>
        |          {ok, Req2, HandlerState2} -&gt;
<font color=red>     0..|              {ok, Req2, State#state{handler_state = HandlerState2}, hibernate};</font>
        |          {reply, {binary, Reply}, Req2, HandlerState2} -&gt;
        |  %		        wf:info(?MODULE,"Bullet Handle Info"),
<font color=red>     0..|              {reply, {binary, Reply}, Req2,</font>
        |                  State#state{handler_state = HandlerState2}, hibernate};
        |          {reply, Reply, Req2, HandlerState2} -&gt;
<font color=red>     0..|              {reply, {text, Reply}, Req2,</font>
        |                  State#state{handler_state = HandlerState2}, hibernate}
        |      end.
        |  
        |  websocket_terminate(_Reason, Req,
        |      #state{handler = Handler, handler_state = HandlerState}) -&gt;
<font color=red>     0..|      Handler:terminate(Req, HandlerState).</font>
</pre>
</body>
</html>
