<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/piotrek/Dokumenty/OneData/merge_merge/op-worker/test_coverage/ets_cache_driver.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/piotrek/Dokumenty/OneData/merge_merge/op-worker/ebin/../src/modules/datastore/drivers/ets_cache_driver.erl by COVER 2015-08-06 at 11:00:44

****************************************************************************

        |  %%%-------------------------------------------------------------------
        |  %%% @author Rafal Slota
        |  %%% @copyright (C) 2015 ACK CYFRONET AGH
        |  %%% This software is released under the MIT license
        |  %%% cited in 'LICENSE.txt'.
        |  %%% @end
        |  %%%-------------------------------------------------------------------
        |  %%% @doc ETS based cache implementation.
        |  %%% @end
        |  %%%-------------------------------------------------------------------
        |  -module(ets_cache_driver).
        |  -author("Rafal Slota").
        |  -behaviour(store_driver_behaviour).
        |  
        |  -include("modules/datastore/datastore.hrl").
        |  -include("modules/datastore/datastore_common_internal.hrl").
        |  -include_lib("ctool/include/logging.hrl").
        |  
        |  %% store_driver_behaviour callbacks
        |  -export([init_bucket/3, healthcheck/1]).
        |  -export([save/2, update/3, create/2, exists/2, get/2, list/3, delete/3]).
        |  -export([add_links/3, delete_links/3, fetch_link/3, foreach_link/4]).
        |  
        |  %% Batch size for list operation
        |  -define(LIST_BATCH_SIZE, 100).
        |  
        |  %%%===================================================================
        |  %%% store_driver_behaviour callbacks
        |  %%%===================================================================
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link store_driver_behaviour} callback init_bucket/2.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec init_bucket(Bucket :: datastore:bucket(), Models :: [model_behaviour:model_config()],
        |      NodeToSync :: node()) -&gt; ok.
        |  init_bucket(_Bucket, Models, _NodeToSync) -&gt;
   240..|      lists:foreach(
        |          fun(#model_config{} = ModelConfig) -&gt;
   240..|              Ans = (catch ets:new(table_name(ModelConfig), [named_table, public, set])),
   240..|              ?info("Creating ets table: ~p, result: ~p", [table_name(ModelConfig), Ans])
        |          end, Models).
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link store_driver_behaviour} callback save/2.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec save(model_behaviour:model_config(), datastore:document()) -&gt;
        |      {ok, datastore:ext_key()} | datastore:generic_error().
        |  save(#model_config{} = ModelConfig, #document{key = Key, value = Value}) -&gt;
  1352..|      true = ets:insert(table_name(ModelConfig), {Key, Value}),
  1352..|      {ok, Key}.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link store_driver_behaviour} callback update/3.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec update(model_behaviour:model_config(), datastore:ext_key(),
        |      Diff :: datastore:document_diff()) -&gt; {ok, datastore:ext_key()} | datastore:update_error().
        |  update(#model_config{bucket = _Bucket} = _ModelConfig, _Key, Diff) when is_function(Diff) -&gt;
<font color=red>     0..|      erlang:error(not_implemented);</font>
        |  update(#model_config{name = ModelName} = ModelConfig, Key, Diff) when is_map(Diff) -&gt;
  1804..|      case ets:lookup(table_name(ModelConfig), Key) of
        |          [] -&gt;
   182..|              {error, {not_found, ModelName}};
        |          [{_, Value}] -&gt;
  1622..|              NewValue = maps:merge(datastore_utils:shallow_to_map(Value), Diff),
  1622..|              true = ets:insert(table_name(ModelConfig), {Key, datastore_utils:shallow_to_record(NewValue)}),
  1622..|              {ok, Key}
        |      end.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link store_driver_behaviour} callback create/2.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec create(model_behaviour:model_config(), datastore:document()) -&gt;
        |      {ok, datastore:ext_key()} | datastore:create_error().
        |  create(#model_config{} = ModelConfig, #document{key = Key, value = Value}) -&gt;
  7753..|      case ets:insert_new(table_name(ModelConfig), {Key, Value}) of
   812..|          false -&gt; {error, already_exists};
  6941..|          true -&gt; {ok, Key}
        |      end.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link store_driver_behaviour} callback get/2.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get(model_behaviour:model_config(), datastore:ext_key()) -&gt;
        |      {ok, datastore:document()} | datastore:get_error().
        |  get(#model_config{name = ModelName} = ModelConfig, Key) -&gt;
  1212..|      case ets:lookup(table_name(ModelConfig), Key) of
        |          [{_, Value}] -&gt;
   607..|              {ok, #document{key = Key, value = Value}};
        |          [] -&gt;
   605..|              {error, {not_found, ModelName}}
        |      end.
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link store_driver_behaviour} callback list/3.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec list(model_behaviour:model_config(),
        |      Fun :: datastore:list_fun(), AccIn :: term()) -&gt;
        |      {ok, Handle :: term()} | datastore:generic_error() | no_return().
        |  list(#model_config{} = ModelConfig, Fun, AccIn) -&gt;
    44..|      SelectAll = [{'_', [], ['$_']}],
    44..|      case ets:select(table_name(ModelConfig), SelectAll, ?LIST_BATCH_SIZE) of
        |          {Obj, Handle} -&gt;
     3..|              list_next(Obj, Handle, Fun, AccIn);
        |          '$end_of_table' -&gt;
    41..|              list_next('$end_of_table', undefined, Fun, AccIn)
        |      end.
        |  
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link store_driver_behaviour} callback delete/2.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec delete(model_behaviour:model_config(), datastore:ext_key(), datastore:delete_predicate()) -&gt;
        |      ok | datastore:generic_error().
        |  delete(#model_config{} = ModelConfig, Key, Pred) -&gt;
  1504..|      case Pred() of
        |          true -&gt;
  1502..|              true = ets:delete(table_name(ModelConfig), Key),
  1502..|              ok;
        |          false -&gt;
     2..|              ok
        |      end.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link store_driver_behaviour} callback exists/2.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec exists(model_behaviour:model_config(), datastore:ext_key()) -&gt;
        |      {ok, boolean()} | datastore:generic_error().
        |  exists(#model_config{} = ModelConfig, Key) -&gt;
  1204..|      {ok, ets:member(table_name(ModelConfig), Key)}.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link store_driver_behaviour} callback healthcheck/1.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec healthcheck(WorkerState :: term()) -&gt; ok | {error, Reason :: term()}.
        |  healthcheck(State) -&gt;
    89..|      maps:fold(
        |          fun
        |              (_, #model_config{name = ModelName}, ok) -&gt;
   712..|                  case ets:info(table_name(ModelName)) of
        |                      undefined -&gt;
<font color=red>     0..|                          {error, {no_ets, table_name(ModelName)}};</font>
   712..|                      _ -&gt; ok
        |                  end;
   148..|              (_, _, Acc) -&gt; Acc
        |          end, ok, State).
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link store_driver_behaviour} callback add_links/3.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec add_links(model_behaviour:model_config(), datastore:ext_key(), [datastore:normalized_link_spec()]) -&gt;
        |      no_return().
        |  add_links(_, _, _) -&gt;
<font color=red>     0..|      erlang:error(not_implemented).</font>
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link store_driver_behaviour} callback delete_links/3.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec delete_links(model_behaviour:model_config(), datastore:ext_key(), [datastore:link_name()] | all) -&gt;
        |      no_return().
        |  delete_links(_, _, _) -&gt;
<font color=red>     0..|      erlang:error(not_implemented).</font>
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link store_driver_behaviour} callback fetch_link/3.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec fetch_link(model_behaviour:model_config(), datastore:ext_key(), datastore:link_name()) -&gt;
        |      no_return().
        |  fetch_link(_, _, _) -&gt;
<font color=red>     0..|      erlang:error(not_implemented).</font>
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% {@link store_driver_behaviour} callback foreach_link/4.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec foreach_link(model_behaviour:model_config(), Key :: datastore:ext_key(),
        |      fun((datastore:link_name(), datastore:link_target(), Acc :: term()) -&gt; Acc :: term()), AccIn :: term()) -&gt;
        |      no_return().
        |  foreach_link(_, _Key, _, _AccIn) -&gt;
<font color=red>     0..|      erlang:error(not_implemented).</font>
        |  
        |  %%%===================================================================
        |  %%% Internal functions
        |  %%%===================================================================
        |  
        |  %%--------------------------------------------------------------------
        |  %% @private
        |  %% @doc
        |  %% Internat helper - accumulator for list/3.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec list_next([term()] | '$end_of_table', term(), datastore:list_fun(), term()) -&gt;
        |      {ok, Acc :: term()} | datastore:generic_error().
        |  list_next([{Key, Obj} | R], Handle, Fun, AccIn) -&gt;
  6850..|      Doc =  #document{key = Key, value = Obj},
  6850..|      case Fun(Doc, AccIn) of
        |          {next, NewAcc} -&gt;
  6850..|              list_next(R, Handle, Fun, NewAcc);
        |          {abort, NewAcc} -&gt;
<font color=red>     0..|              {ok, NewAcc}</font>
        |      end;
        |  list_next('$end_of_table' = EoT, Handle, Fun, AccIn) -&gt;
    44..|      case Fun(EoT, AccIn) of
        |          {next, NewAcc} -&gt;
<font color=red>     0..|              list_next(EoT, Handle, Fun, NewAcc);</font>
        |          {abort, NewAcc} -&gt;
    44..|              {ok, NewAcc}
        |      end;
        |  list_next([], Handle, Fun, AccIn) -&gt;
    71..|      case ets:select(Handle) of
        |          {Objects, NewHandle} -&gt;
    68..|              list_next(Objects, NewHandle, Fun, AccIn);
        |          '$end_of_table' -&gt;
     3..|              list_next('$end_of_table', undefined, Fun, AccIn)
        |      end.
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @private
        |  %% @doc
        |  %% Gets ETS table name for given model.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec table_name(model_behaviour:model_config() | atom()) -&gt; atom().
        |  table_name(#model_config{name = ModelName}) -&gt;
 16973..|      table_name(ModelName);
        |  table_name(TabName) when is_atom(TabName) -&gt;
 17685..|      binary_to_atom(&lt;&lt;"lc_", (erlang:atom_to_binary(TabName, utf8))/binary&gt;&gt;, utf8).</pre>
</body>
</html>
