<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/piotrek/Dokumenty/OneData/merge_merge/op-worker/test_coverage/fslogic_req_special.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/piotrek/Dokumenty/OneData/merge_merge/op-worker/ebin/../src/modules/fslogic/fslogic_requests/fslogic_req_special.erl by COVER 2015-08-06 at 11:00:40

****************************************************************************

        |  %% ===================================================================
        |  %% @author Rafal Slota
        |  %% @copyright (C): 2013, ACK CYFRONET AGH
        |  %% This software is released under the MIT license
        |  %% cited in 'LICENSE.txt'.
        |  %% @end
        |  %% ===================================================================
        |  %% @doc: FSLogic request handlers for special files.
        |  %% @end
        |  %% ===================================================================
        |  -module(fslogic_req_special).
        |  -author("Rafal Slota").
        |  
        |  -include("proto/oneclient/fuse_messages.hrl").
        |  -include("modules/fslogic/fslogic_common.hrl").
        |  -include_lib("ctool/include/logging.hrl").
        |  
        |  %% API
        |  -export([mkdir/4, read_dir/4, link/3, read_link/2]).
        |  
        |  %%--------------------------------------------------------------------
        |  %% API functions
        |  %%--------------------------------------------------------------------
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Creates new directory.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec mkdir(CTX :: fslogic_worker:ctx(), ParentUUID :: file_meta:uuid(),
        |      Name :: file_meta:name(), Mode :: file_meta:posix_permissions()) -&gt;
        |      FuseResponse :: #fuse_response{} | no_return().
        |  -check_permissions([{write, 2}, {exec, 2}]).
        |  mkdir(#fslogic_ctx{session = #session{identity = #identity{user_id = UUID}}} = CTX,
        |      UUID, Name, Mode) -&gt;
    23..|      {ok, #document{key = DefaultSpaceUUID}} = fslogic_spaces:get_default_space(CTX),
    23..|      mkdir(CTX, DefaultSpaceUUID, Name, Mode);
        |  mkdir(CTX, ParentUUID, Name, Mode) -&gt;
    36..|      CTime = utils:time(),
    36..|      File = #document{value = #file_meta{
        |          name = Name,
        |          type = ?DIRECTORY_TYPE,
        |          mode = Mode,
        |          mtime = CTime,
        |          atime = CTime,
        |          ctime = CTime,
        |          uid = fslogic_context:get_user_id(CTX)
        |      }},
    36..|      case file_meta:create({uuid, ParentUUID}, File) of
        |          {ok, _} -&gt;
    35..|              {ok, _} = file_meta:update({uuid, ParentUUID}, #{mtime =&gt; CTime}),
    35..|              #fuse_response{status = #status{code = ?OK}};
        |          {error, already_exists} -&gt;
     1..|              #fuse_response{status = #status{code = ?EEXIST}}
        |      end.
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Lists directory. Start with ROffset entity and limit returned list to RCount size.
        |  %% For best performance use following arg types: document -&gt; uuid -&gt; path
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec read_dir(CTX :: fslogic_worker:ctx(), File :: fslogic_worker:file(),
        |      Offset :: file_meta:offset(), Count :: file_meta:size()) -&gt;
        |      FuseResponse :: #fuse_response{} | no_return().
        |  -check_permissions([{read, 2}]).
        |  read_dir(CTX, File, Offset, Size) -&gt;
   849..|      UserId = fslogic_context:get_user_id(CTX),
   849..|      {ok, #document{key = Key} = FileDoc} = file_meta:get(File),
   849..|      {ok, ChildLinks} = file_meta:list_children(FileDoc, Offset, Size),
        |  
   849..|      ?debug("read_dir ~p ~p ~p links: ~p", [File, Offset, Size, ChildLinks]),
        |  
   849..|      SpacesKey = fslogic_path:spaces_uuid(UserId),
   849..|      case Key of
        |          UserId -&gt;
   360..|              {ok, DefaultSpace} = fslogic_spaces:get_default_space(CTX),
   360..|              {ok, DefaultSpaceChildLinks} =
        |                  case Offset of
        |                      0 -&gt;
    68..|                          file_meta:list_children(DefaultSpace, 0, Size - 1);
        |                      _ -&gt;
   292..|                          file_meta:list_children(DefaultSpace, Offset - 1, Size)
        |                  end,
   360..|                  #fuse_response{status = #status{code = ?OK},
        |                      fuse_response = #file_children{
        |                          child_links = ChildLinks ++ DefaultSpaceChildLinks
        |                      }
        |                  };
        |          SpacesKey -&gt;
   134..|              {ok, #document{value = #onedata_user{space_ids = SpacesIds}}} =
        |                  onedata_user:get(UserId),
   134..|              SpaceRes = [file_meta:get(SpacesId) || SpacesId &lt;- SpacesIds],
        |  
   134..|              Children =
        |                  case Offset &lt; length(SpacesIds)  of
        |                      true -&gt;
    70..|                          SpaceLinks = [#child_link{uuid = SpaceId, name = SpaceName} ||
    70..|                              {ok, #document{key = SpaceId, value = #file_meta{name = SpaceName}}} &lt;- SpaceRes],
        |  
    70..|                          lists:sublist(SpaceLinks, Offset + 1, Size);
        |                      false -&gt;
    64..|                          []
        |                  end,
        |  
   134..|              #fuse_response{status = #status{code = ?OK},
        |                  fuse_response = #file_children{
        |                      child_links = Children
        |                  }
        |              };
        |          _ -&gt;
   355..|              #fuse_response{status = #status{code = ?OK},
        |                  fuse_response = #file_children{child_links = ChildLinks}}
        |      end.
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Creates new symbolic link.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec link(fslogic_worker:ctx(), Path :: file_meta:path(), LinkValue :: binary()) -&gt;
        |      no_return().
        |  link(_CTX, _File, _LinkValue) -&gt;
<font color=red>     0..|      ?NOT_IMPLEMENTED.</font>
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Gets value of symbolic link.
        |  %% For best performance use following arg types: document -&gt; uuid -&gt; path
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec read_link(fslogic_worker:ctx(), File :: fslogic_worker:file()) -&gt;
        |      no_return().
        |  read_link(_CTX, _File) -&gt;
<font color=red>     0..|      ?NOT_IMPLEMENTED.</font>
        |  
        |  %%--------------------------------------------------------------------
        |  %% Internal functions
        |  %%--------------------------------------------------------------------
</pre>
</body>
</html>
