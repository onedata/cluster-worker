<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/piotrek/Dokumenty/OneData/merge_merge/op-worker/test_coverage/opn_redirect_handler.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/piotrek/Dokumenty/OneData/merge_merge/op-worker/ebin/../src/modules/http_worker/redirector/opn_redirect_handler.erl by COVER 2015-08-06 at 11:00:44

****************************************************************************

        |  %%%--------------------------------------------------------------------
        |  %%% @author Lukasz Opiola
        |  %%% @copyright (C) 2014 ACK CYFRONET AGH
        |  %%% This software is released under the MIT license
        |  %%% cited in 'LICENSE.txt'.
        |  %%% @end
        |  %%%--------------------------------------------------------------------
        |  %%% @doc This module handles requests directed to http and returns a 301 redirect to https.
        |  %%% @end
        |  %%%--------------------------------------------------------------------
        |  -module(opn_redirect_handler).
        |  -author("Lukasz Opiola").
        |  
        |  -include_lib("ctool/include/logging.hrl").
        |  
        |  %% API
        |  -export([init/3, handle/2, terminate/3]).
        |  
        |  %%%===================================================================
        |  %%% API
        |  %%%===================================================================
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Cowboy handler callback, no state is required
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec init(term(), term(), term()) -&gt; {ok, term(), []}.
        |  init(_Type, Req, _Opts) -&gt;
    84..|      {ok, Req, []}.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Handles a request returning a HTTP Redirect (301 - Moved permanently).
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec handle(term(), term()) -&gt; {ok, term(), term()}.
        |  handle(Req, State) -&gt;
    84..|      {FullHostname, _} = cowboy_req:header(&lt;&lt;"host"&gt;&gt;, Req),
    84..|      {QS, _} = cowboy_req:qs(Req),
        |      % Remove the leading 'www.' if present
    84..|      Hostname = case FullHostname of
<font color=red>     0..|                     &lt;&lt;"www.", Rest/binary&gt;&gt; -&gt; Rest;</font>
    84..|                     _ -&gt; FullHostname
        |                 end,
    84..|      {Path, _} = cowboy_req:path(Req),
    84..|      {ok, Req2} = opn_cowboy_bridge:apply(cowboy_req, reply, [
        |          301,
        |          [
        |              {&lt;&lt;"location"&gt;&gt;, &lt;&lt;"https://", Hostname/binary, Path/binary, "?", QS/binary&gt;&gt;},
        |              {&lt;&lt;"content-type"&gt;&gt;, &lt;&lt;"text/html"&gt;&gt;}
        |          ],
        |          &lt;&lt;""&gt;&gt;,
        |          Req
        |      ]),
    84..|      {ok, Req2, State}.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Cowboy handler callback, no cleanup needed
        |  %%--------------------------------------------------------------------
        |  -spec terminate(term(), term(), term()) -&gt; ok.
        |  terminate(_Reason, _Req, _State) -&gt;
    84..|      ok.</pre>
</body>
</html>
