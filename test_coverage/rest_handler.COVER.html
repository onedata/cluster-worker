<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/piotrek/Dokumenty/OneData/merge_merge/op-worker/test_coverage/rest_handler.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/piotrek/Dokumenty/OneData/merge_merge/op-worker/ebin/../src/modules/http_worker/rest/rest_handler.erl by COVER 2015-08-06 at 11:00:41

****************************************************************************

        |  %%%--------------------------------------------------------------------
        |  %%% @author Lukasz Opiola
        |  %%% @copyright (C) 2013 ACK CYFRONET AGH
        |  %%% This software is released under the MIT license
        |  %%% cited in 'LICENSE.txt'.
        |  %%% @end
        |  %%%--------------------------------------------------------------------
        |  %%% @doc This is a cowboy handler module, implementing cowboy_rest interface.
        |  %%% It handles REST requests by routing them to proper rest module.
        |  %%% @end
        |  %%%--------------------------------------------------------------------
        |  -module(rest_handler).
        |  -author("Lukasz Opiola").
        |  
        |  -include("global_definitions.hrl").
        |  -include("modules/http_worker/http_common.hrl").
        |  -include("modules/datastore/datastore.hrl").
        |  -include_lib("ctool/include/logging.hrl").
        |  
        |  % the state of request, it is created in rest_init function, and passed to every cowboy callback functions
        |  -record(state, {
        |      identity :: #identity{}
        |  }).
        |  
        |  %% API
        |  -export([init/3, terminate/3, rest_init/2, allowed_methods/2, malformed_request/2,
        |      is_authorized/2, resource_exists/2, content_types_provided/2, content_types_accepted/2, delete_resource/2]).
        |  
        |  %% Content type routing functions
        |  -export([get_resource/2, handle_json_data/2]).
        |  
        |  %%%===================================================================
        |  %%% API
        |  %%%===================================================================
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Cowboy callback function
        |  %% Imposes a cowboy upgrade protocol to cowboy_rest - this module is
        |  %% now treated as REST module by cowboy.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec init(term(), term(), term()) -&gt; {upgrade, protocol, cowboy_rest, req(), term()}.
        |  init(_, Req, Opts) -&gt;
     2..|      {upgrade, protocol, cowboy_rest, Req, Opts}.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Cowboy callback function
        |  %% Handles cleanup
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec terminate(Reason :: term(), req(), #state{}) -&gt; ok.
        |  terminate(_, _, _) -&gt;
<font color=red>     0..|      ok.</font>
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Cowboy callback function
        |  %% Called right after protocol upgrade to init the request context.
        |  %% Will shut down the connection if the peer doesn't provide a valid
        |  %% proxy certificate.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec rest_init(req(), term()) -&gt; {ok, req(), term()} | {shutdown, req()}.
        |  rest_init(Req, _Opts) -&gt;
     2..|      {ok, Req, #state{}}.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Cowboy callback function
        |  %% Returns methods that are allowed.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec allowed_methods(req(), #state{} | {error, term()}) -&gt; {[binary()], req(), #state{}}.
        |  allowed_methods(Req, State) -&gt;
     2..|      {[&lt;&lt;"PUT"&gt;&gt;, &lt;&lt;"GET"&gt;&gt;, &lt;&lt;"DELETE"&gt;&gt;], Req, State}.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Cowboy callback function
        |  %% Checks if request contains all mandatory fields and their values are set properly
        |  %% depending on requested operation
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec malformed_request(req(), #state{}) -&gt; {boolean(), req(), #state{}}.
        |  malformed_request(Req, State) -&gt;
     2..|      {false, Req, State}.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Cowboy callback function
        |  %% Return whether the user is authorized to perform the action.
        |  %% This function should be used to perform any necessary authentication of the
        |  %% user before attempting to perform any action on the resource.
        |  %% If the authentication fails, the value returned will be sent as the value for
        |  %% the www-authenticate header in the 401 Unauthorized response.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec is_authorized(req(), #state{}) -&gt; {boolean(), req(), #state{}}.
        |  is_authorized(Req, State) -&gt;
     2..|      case rest_auth:authenticate(Req) of
        |          {{ok, Iden}, NewReq} -&gt;
     1..|              {true, NewReq, State#state{identity = Iden}};
        |          {{error, {not_found, _}}, NewReq} -&gt;
<font color=red>     0..|              GrUrl = gr_plugin:get_gr_url(),</font>
<font color=red>     0..|              ProviderId = oneprovider:get_provider_id(),</font>
<font color=red>     0..|              {_, NewReq2} = cowboy_req:host(NewReq),</font>
<font color=red>     0..|              {&lt;&lt;"http://", Url/binary&gt;&gt;, NewReq3} = cowboy_req:url(NewReq2),</font>
        |  
<font color=red>     0..|              {ok, NewReq4} = cowboy_req:reply(</font>
        |                  307,
        |                  [
        |                      {&lt;&lt;"location"&gt;&gt;, &lt;&lt;(list_to_binary(GrUrl))/binary,
        |                          "/user/providers/", ProviderId/binary, "/auth_proxy?ref=https://", Url/binary&gt;&gt;}
        |                  ],
        |                  &lt;&lt;""&gt;&gt;,
        |                  NewReq3
        |              ),
<font color=red>     0..|              {halt, NewReq4, State};</font>
        |          {{error, Error}, NewReq} -&gt;
     1..|              ?debug("Authentication error ~p", [Error]),
     1..|              {{false, &lt;&lt;"authentication_error"&gt;&gt;}, NewReq, State}
        |      end.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Cowboy callback function
        |  %% Determines if resource identified by Filepath exists.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec resource_exists(req(), #state{}) -&gt; {boolean(), req(), #state{}}.
        |  resource_exists(Req, State) -&gt;
     1..|      {false, Req, State}.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Cowboy callback function
        |  %% Returns content types that can be provided.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec content_types_provided(req(), #state{}) -&gt; {[{binary(), atom()}], req(), #state{}}.
        |  content_types_provided(Req, State) -&gt;
     1..|      {[
        |          {&lt;&lt;"application/cdmi-container"&gt;&gt;, get_resource}
        |      ], Req, State}.
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc Cowboy callback function
        |  %% Returns content-types that are accepted by REST handler and what
        |  %% functions should be used to process the requests.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec content_types_accepted(req(), #state{}) -&gt; {[{binary(), atom()}], req(), #state{}}.
        |  content_types_accepted(Req, State) -&gt;
<font color=red>     0..|      {[</font>
        |          {&lt;&lt;"application/json"&gt;&gt;, handle_json_data}
        |      ], Req, State}.
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Cowboy callback function
        |  %% Handles DELETE requests.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec delete_resource(req(), #state{}) -&gt; {term(), req(), #state{}}.
        |  delete_resource(Req, State) -&gt;
<font color=red>     0..|      {true, Req, State}.</font>
        |  
        |  %%%===================================================================
        |  %%% Content type routing functions
        |  %%%===================================================================
        |  %%--------------------------------------------------------------------
        |  %% This functions are needed by cowboy for registration in
        |  %% content_types_accepted/content_types_provided methods and simply delegates
        |  %% their responsibility to adequate handler modules
        |  %%--------------------------------------------------------------------
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Handles GET with "application/json" content-type
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get_resource(req(), #state{}) -&gt; {term(), req(), #state{}}.
        |  get_resource(Req, State) -&gt;
<font color=red>     0..|      {&lt;&lt;"ok"&gt;&gt;, Req, State}.</font>
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Handles PUT with "application/json" content-type
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec handle_json_data(req(), #state{}) -&gt; {term(), req(), #state{}}.
        |  handle_json_data(Req, State = #state{identity = ?GLOBALREGISTRY_IDENTITY}) -&gt;
<font color=red>     0..|      case cowboy_req:path_info(Req) of</font>
        |          {[&lt;&lt;"auth"&gt;&gt;], _}  -&gt;
<font color=red>     0..|              {ok, Body, Req2} = cowboy_req:body(Req),</font>
<font color=red>     0..|              Json = mochijson2:decode(Body, [{format, proplist}]),</font>
<font color=red>     0..|              User = proplists:get_value(&lt;&lt;"user"&gt;&gt;, Json),</font>
<font color=red>     0..|              Cert = proplists:get_value(&lt;&lt;"cert"&gt;&gt;, Json),</font>
        |  
<font color=red>     0..|              UserId = proplists:get_value(&lt;&lt;"userId"&gt;&gt;, User),</font>
<font color=red>     0..|              UserName = proplists:get_value(&lt;&lt;"name"&gt;&gt;, User),</font>
        |  
<font color=red>     0..|              case lists:any(fun(X) -&gt; X =:= undefined end, [UserId, UserName, Cert]) of</font>
<font color=red>     0..|                  true -&gt; {false, Req2, State};</font>
        |                  false -&gt;
<font color=red>     0..|                      {ok, _} = onedata_user:save(#document{key = UserId, value = #onedata_user{name = UserName}}),</font>
<font color=red>     0..|                      [{'Certificate', DerCert, _}] = public_key:pem_decode(Cert),</font>
<font color=red>     0..|                      OtpCert = public_key:pkix_decode_cert(DerCert, otp),</font>
<font color=red>     0..|                      {ok, _} = identity:save(#document{key = OtpCert, value = #identity{user_id = UserId}}),</font>
<font color=red>     0..|                      {true, Req2, State}</font>
        |              end
        |      end;
        |  handle_json_data(Req, State) -&gt;
<font color=red>     0..|      {ok, Req2} = cowboy_req:reply(401, [], &lt;&lt;""&gt;&gt;, Req),</font>
<font color=red>     0..|      {halt, Req2, State}.</font>
</pre>
</body>
</html>
