<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/piotrek/Dokumenty/OneData/merge_merge/op-worker/test_coverage/oneprovider.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/piotrek/Dokumenty/OneData/merge_merge/op-worker/ebin/../src/utils/oneprovider.erl by COVER 2015-08-06 at 11:00:40

****************************************************************************

        |  %%%-------------------------------------------------------------------
        |  %%% @author Rafal Slota
        |  %%% @author Lukasz Opiola
        |  %%% @copyright (C) 2014 ACK CYFRONET AGH
        |  %%% This software is released under the MIT license
        |  %%% cited in 'LICENSE.txt'.
        |  %%% @end
        |  %%%-------------------------------------------------------------------
        |  %%% @doc
        |  %%% Library module for oneprovider-wide operations.
        |  %%% @end
        |  %%%-------------------------------------------------------------------
        |  -module(oneprovider).
        |  -author("Rafal Slota").
        |  -author("Lukasz Opiola").
        |  
        |  -include("global_definitions.hrl").
        |  -include("modules/datastore/datastore.hrl").
        |  -include_lib("public_key/include/public_key.hrl").
        |  -include_lib("ctool/include/logging.hrl").
        |  
        |  -define(GRPKEY_ENV, grpkey_path).
        |  -define(GRPCSR_ENV, grpcsr_path).
        |  -define(GRPCERT_ENV, grpcert_path).
        |  
        |  %% API
        |  -export([get_node_hostname/0, get_node_ip/0]).
        |  -export([get_provider_domain/0, get_gr_domain/0]).
        |  -export([get_provider_id/0, get_globalregistry_cert/0]).
        |  -export([register_in_gr/3, register_in_gr_dev/3, save_file/2]).
        |  
        |  %%%===================================================================
        |  %%% API
        |  %%%===================================================================
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Returns the hostname of the node, based on its erlang node name.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get_node_hostname() -&gt; string().
        |  get_node_hostname() -&gt;
    30..|      utils:get_host(node()).
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Returns the IP of the node, retrieved from node_manager, which has
        |  %% acquired it by contacting GR.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get_node_ip() -&gt; {byte(), byte(), byte(), byte()}.
        |  get_node_ip() -&gt;
<font color=red>     0..|      node_manager:get_ip_address().</font>
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Returns the domain of the provider, which is specified in env.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get_provider_domain() -&gt; string().
        |  get_provider_domain() -&gt;
    56..|      {ok, Domain} = application:get_env(?APP_NAME, provider_domain),
    56..|      gui_str:to_list(Domain).
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Returns the domain of GR, which is specified in env.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get_gr_domain() -&gt; string().
        |  get_gr_domain() -&gt;
    26..|      {ok, Hostname} = application:get_env(?APP_NAME, global_registry_domain),
    26..|      gui_str:to_list(Hostname).
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Registers in GR using config from app.src (cert locations).
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec register_in_gr(NodeList :: [node()], KeyFilePassword :: string(), ClientName :: binary()) -&gt;
        |      {ok, ProviderID :: binary()} | {error, term()}.
        |  register_in_gr(NodeList, KeyFilePassword, ProviderName) -&gt;
<font color=red>     0..|      try</font>
<font color=red>     0..|          GRPKeyPath = gr_plugin:get_key_path(),</font>
<font color=red>     0..|          GRPCertPath = gr_plugin:get_cert_path(),</font>
<font color=red>     0..|          GRPCSRPath = gr_plugin:get_csr_path(),</font>
        |          % Create a CSR
<font color=red>     0..|          0 = csr_creator:create_csr(KeyFilePassword, GRPKeyPath, GRPCSRPath),</font>
<font color=red>     0..|          {ok, CSR} = file:read_file(GRPCSRPath),</font>
<font color=red>     0..|          {ok, Key} = file:read_file(GRPKeyPath),</font>
        |          % Send signing request to GR
<font color=red>     0..|          IPAddresses = get_all_nodes_ips(NodeList),</font>
<font color=red>     0..|          RedirectionPoint = &lt;&lt;"https://", (hd(IPAddresses))/binary&gt;&gt;,</font>
<font color=red>     0..|          Parameters = [</font>
        |              {&lt;&lt;"urls"&gt;&gt;, IPAddresses},
        |              {&lt;&lt;"csr"&gt;&gt;, CSR},
        |              {&lt;&lt;"redirectionPoint"&gt;&gt;, RedirectionPoint},
        |              {&lt;&lt;"clientName"&gt;&gt;, ProviderName}
        |          ],
<font color=red>     0..|          {ok, ProviderId, Cert} = gr_providers:register(provider, Parameters),</font>
<font color=red>     0..|          ok = file:write_file(GRPCertPath, Cert),</font>
<font color=red>     0..|          OtherWorkers = NodeList -- [node()],</font>
<font color=red>     0..|          save_file_on_hosts(OtherWorkers, GRPKeyPath, Key),</font>
<font color=red>     0..|          save_file_on_hosts(OtherWorkers, GRPCertPath, Cert),</font>
<font color=red>     0..|          {ok, ProviderId}</font>
        |      catch
        |          T:M -&gt;
<font color=red>     0..|              ?error_stacktrace("Cannot register in GlobalRegistry - ~p:~p", [T, M]),</font>
<font color=red>     0..|              {error, M}</font>
        |      end.
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Registers in GR using config from app.src (cert locations).
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec register_in_gr_dev(NodeList :: [node()], KeyFilePassword :: string(), ClientName :: binary()) -&gt;
        |      {ok, ProviderID :: binary()} | {error, term()}.
        |  register_in_gr_dev(NodeList, KeyFilePassword, ProviderName) -&gt;
<font color=red>     0..|      try</font>
<font color=red>     0..|          GRPKeyPath = gr_plugin:get_key_path(),</font>
<font color=red>     0..|          GRPCertPath = gr_plugin:get_cert_path(),</font>
<font color=red>     0..|          GRPCSRPath = gr_plugin:get_csr_path(),</font>
        |          % Create a CSR
<font color=red>     0..|          0 = csr_creator:create_csr(KeyFilePassword, GRPKeyPath, GRPCSRPath),</font>
<font color=red>     0..|          {ok, CSR} = file:read_file(GRPCSRPath),</font>
<font color=red>     0..|          {ok, Key} = file:read_file(GRPKeyPath),</font>
        |          % Send signing request to GR
<font color=red>     0..|          IPAddresses = get_all_nodes_ips(NodeList),</font>
<font color=red>     0..|          ProviderDomain = gui_str:to_binary(oneprovider:get_provider_domain()),</font>
<font color=red>     0..|          RedirectionPoint = &lt;&lt;"https://", ProviderDomain/binary&gt;&gt;,</font>
<font color=red>     0..|          Parameters = [</font>
        |              {&lt;&lt;"urls"&gt;&gt;, IPAddresses},
        |              {&lt;&lt;"csr"&gt;&gt;, CSR},
        |              {&lt;&lt;"redirectionPoint"&gt;&gt;, RedirectionPoint},
        |              {&lt;&lt;"clientName"&gt;&gt;, ProviderName},
        |              {&lt;&lt;"uuid"&gt;&gt;, ProviderName}
        |          ],
<font color=red>     0..|          {ok, ProviderId, Cert} = gr_providers:register_with_uuid(provider, Parameters),</font>
<font color=red>     0..|          ok = file:write_file(GRPCertPath, Cert),</font>
<font color=red>     0..|          OtherWorkers = NodeList -- [node()],</font>
<font color=red>     0..|          save_file_on_hosts(OtherWorkers, GRPKeyPath, Key),</font>
<font color=red>     0..|          save_file_on_hosts(OtherWorkers, GRPCertPath, Cert),</font>
<font color=red>     0..|          {ok, ProviderId}</font>
        |      catch
        |          T:M -&gt;
<font color=red>     0..|              ?error_stacktrace("Cannot register in GlobalRegistry - ~p:~p", [T, M]),</font>
<font color=red>     0..|              {error, M}</font>
        |      end.
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Returns Provider ID for current oneprovider instance.
        |  %% Fails with undefined exception if the oneprovider is not registered as a provider.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get_provider_id() -&gt; ProviderId :: binary() | no_return().
        |  get_provider_id() -&gt;
        |      % Cache the provider ID so that we don't decode the cert every time
<font color=red>     0..|      case application:get_env(?APP_NAME, provider_id) of</font>
        |          {ok, ProviderId} -&gt;
<font color=red>     0..|              ProviderId;</font>
        |          _ -&gt;
<font color=red>     0..|              {ok, Bin} = file:read_file(gr_plugin:get_cert_path()),</font>
<font color=red>     0..|              [{_, PeerCertDer, _} | _] = public_key:pem_decode(Bin),</font>
<font color=red>     0..|              PeerCert = public_key:pkix_decode_cert(PeerCertDer, otp),</font>
<font color=red>     0..|              ProviderId = get_provider_id(PeerCert),</font>
<font color=red>     0..|              application:set_env(?APP_NAME, provider_id, ProviderId),</font>
<font color=red>     0..|              ProviderId</font>
        |      end.
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Returns GR public certificate
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get_globalregistry_cert() -&gt; #'OTPCertificate'{} | no_return().
        |  get_globalregistry_cert() -&gt;
        |      % Cache the cert so that we don't decode the cert every time
    30..|      case application:get_env(?APP_NAME, globalregistry_certificate) of
        |          {ok, GrCert} -&gt;
<font color=red>     0..|              GrCert;</font>
        |          _ -&gt;
    30..|              {ok, PemCert} = file:read_file(gr_plugin:get_cacert_path()),
    30..|              [{'Certificate', DerCert, _}] = public_key:pem_decode(PemCert),
    30..|              GrCert = #'OTPCertificate'{} = public_key:pkix_decode_cert(DerCert, otp),
    30..|              application:set_env(?APP_NAME, globalregistry_certificate, GrCert),
    30..|              GrCert
        |      end.
        |  
        |  
        |  %%%===================================================================
        |  %%% Internal functions
        |  %%%===================================================================
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Returns ProviderId based on provider's certificate (issued by globalregistry).
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get_provider_id(Cert :: #'OTPCertificate'{}) -&gt; ProviderId :: binary() | no_return().
        |  get_provider_id(#'OTPCertificate'{} = Cert) -&gt;
        |      #'OTPCertificate'{tbsCertificate =
<font color=red>     0..|      #'OTPTBSCertificate'{subject = {rdnSequence, Attrs}}} = Cert,</font>
        |  
<font color=red>     0..|      [ProviderId] = lists:filtermap(fun([Attribute]) -&gt;</font>
<font color=red>     0..|          case Attribute#'AttributeTypeAndValue'.type of</font>
        |              ?'id-at-commonName' -&gt;
<font color=red>     0..|                  {_, Id} = Attribute#'AttributeTypeAndValue'.value,</font>
<font color=red>     0..|                  {true, utils:ensure_binary(Id)};</font>
<font color=red>     0..|              _ -&gt; false</font>
        |          end
        |      end, Attrs),
        |  
<font color=red>     0..|      utils:ensure_binary(ProviderId).</font>
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Saves given file on given hosts.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec save_file_on_hosts(Hosts :: [atom()], Path :: file:name_all(), Content :: binary()) -&gt;
        |      ok | {error, [{node(), Reason :: term()}]}.
        |  save_file_on_hosts(Hosts, Path, Content) -&gt;
<font color=red>     0..|      Res = lists:foldl(</font>
        |          fun(Host, Acc) -&gt;
<font color=red>     0..|              case rpc:call(Host, ?MODULE, save_file, [Path, Content]) of</font>
        |                  ok -&gt;
<font color=red>     0..|                      Acc;</font>
        |                  {error, Reason} -&gt;
<font color=red>     0..|                      [{Host, Reason} | Acc]</font>
        |              end
        |          end, [], Hosts),
<font color=red>     0..|      case Res of</font>
<font color=red>     0..|          [] -&gt; ok;</font>
<font color=red>     0..|          Other -&gt; Other</font>
        |      end.
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Saves given file under given path.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec save_file(Path :: file:name_all(), Content :: binary()) -&gt; ok | {error, term()}.
        |  save_file(Path, Content) -&gt;
<font color=red>     0..|      try</font>
<font color=red>     0..|          file:make_dir(filename:dirname(Path)),</font>
<font color=red>     0..|          ok = file:write_file(Path, Content),</font>
<font color=red>     0..|          ok</font>
        |      catch
        |          _:Reason -&gt;
<font color=red>     0..|              ?error("Cannot save file ~p ~p", [Path, Reason]),</font>
<font color=red>     0..|              {error, Reason}</font>
        |      end.
        |  
        |  
        |  %%--------------------------------------------------------------------
        |  %% @doc
        |  %% Returns a list of all nodes IP addresses.
        |  %% @end
        |  %%--------------------------------------------------------------------
        |  -spec get_all_nodes_ips(NodeList :: [node()]) -&gt; [binary()].
        |  get_all_nodes_ips(NodeList) -&gt;
<font color=red>     0..|      utils:pmap(</font>
        |          fun(Node) -&gt;
<font color=red>     0..|              {ok, IPAddr} = rpc:call(Node, gr_providers, check_ip_address, [provider]),</font>
<font color=red>     0..|              IPAddr</font>
        |          end, NodeList).
        |  
        |  
        |  
        |  
        |  
</pre>
</body>
</html>
